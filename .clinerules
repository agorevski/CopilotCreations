# Discord Copilot Bot - Project Rules

## Project Overview
This is a Discord bot written in Python that executes the `copilot` CLI to create projects based on user prompts. The bot provides real-time feedback through Discord messages showing file tree updates and command output.

## Tech Stack
- Python 3.10+
- discord.py (official Discord library)
- python-dotenv for environment configuration
- asyncio for concurrent subprocess handling

## Project Structure
```
discord-copilot-bot/
├── .env.example    # Template for environment variables
├── .env            # Actual environment variables (not in git)
├── .gitignore      # Git ignore rules
├── README.md       # Documentation
├── requirements.txt # Python dependencies
├── run.py          # Main bot entry point
├── src/            # Source code
│   ├── bot.py      # Discord bot client with factory pattern
│   ├── config.py   # Configuration with explicit initialization
│   ├── commands/   # Discord slash commands
│   └── utils/      # Utility modules including async_buffer.py
├── tests/          # Test suite
└── projects/       # Generated projects directory (not in git)
```

## Key Patterns

### Discord Bot
- Uses `discord.py` with `app_commands` for slash commands
- **Factory Pattern** - Bot instances are created via `get_bot()` function
- **Explicit Initialization** - Configuration is loaded via `init_config()` at startup
- Async/await patterns throughout

### Subprocess Management
- Uses `asyncio.create_subprocess_exec` for spawning copilot
- 30-minute timeout on all subprocesses
- Concurrent user support (each command spawns separate process)
- **Graceful Shutdown** - Signal handlers for clean termination (SIGINT, SIGTERM)

### Message Updates
- File tree message updates every 1 second (only when content changes)
- Output window updates every 1 second (only when content changes)
- **Thread-Safe Buffers** - `AsyncOutputBuffer` class for race-condition-free concurrent access
- Final summary message on completion

### Code Organization
- **Modular Functions** - Long command handlers are broken into focused helper functions
- **DRY Principle** - Common patterns extracted into reusable utilities
- **Single Responsibility** - Each function does one thing well

## Environment Variables
- `DISCORD_BOT_TOKEN` - Required Discord bot token
- `GITHUB_ENABLED` - Enable GitHub integration (default: false)
- `GITHUB_TOKEN` - GitHub Personal Access Token
- `GITHUB_USERNAME` - GitHub username

## Commands
- `/createproject prompt:<text> [model:<model>]` - Main command

## Code Style
- Use type hints for function parameters and return types
- Use async/await for all I/O operations
- **Always log exceptions** - never use bare `except: pass` blocks; log errors with appropriate levels (debug/warning/error)
- Define magic numbers and strings as named constants in `config.py`
- Sanitize user input for filesystem operations
- **Avoid import-time side effects** - use explicit initialization functions
- **Use format_error_message()** for consistent error formatting in Discord responses
- **Validate user input** - check prompt length, model format before processing

## Configuration Constants
All magic numbers and strings should be defined in `src/config.py`:
- `PROMPT_LOG_TRUNCATE_LENGTH` - Length for truncating prompts in logs (100 chars)
- `PROMPT_SUMMARY_TRUNCATE_LENGTH` - Length for truncating prompts in summaries (200 chars)
- `UNIQUE_ID_LENGTH` - Length of UUID prefix for unique identifiers (8 chars)
- `PROGRESS_LOG_INTERVAL_SECONDS` - Interval for progress logging (30 seconds)
- `TIMEOUT_SECONDS` - Process timeout duration
- `UPDATE_INTERVAL` - Message update check interval
- `MAX_MESSAGE_LENGTH` - Discord message character limit
- `MAX_PROMPT_LENGTH` - Maximum prompt length (10,000 chars)
- `MODEL_NAME_PATTERN` - Regex pattern for valid model names

## Testing
- Test with Discord bot in a private server first
- Verify concurrent command handling
- Test timeout behavior with long-running prompts
- Use `create_bot()` for test isolation (creates new instances)

## Future Considerations
- Docker integration planned for later
- May add more commands for project management
- Consider adding queue system for high-load scenarios
